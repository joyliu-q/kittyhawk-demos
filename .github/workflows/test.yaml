# Generated by cdkactions. Do not modify
# Generated as part of the 'application' stack.
name: Build and Deploy
on: pull_request
env:
  PR_NUMBER: ${{ github.event.pull_request.number }}
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - id: synth
        name: Synth cdk8s manifests
        run: |-
          # get repo name (by removing owner/organization)
          export RELEASE_NAME=\${REPOSITORY#*/}

          # Export RELEASE_NAME as an output
          echo "::set-output name=RELEASE_NAME::$RELEASE_NAME"
        env:
          GIT_SHA: ${{ github.sha }}
          REPOSITORY: ${{ github.repository }}
      - name: Deployment Test
        run: |-
          # get repo name from synth step
          RELEASE_NAME=\${{ steps.synth.outputs.RELEASE_NAME }}

          # check for feature-branch deployment set-up
          if [[ $GIT_REF != 'refs/heads/main' ]]; 
          then
            export IS_FEATURE_BRANCH=true;
            export RELEASE_NAME=$RELEASE_NAME-pr-$PR_NUMBER;
          fi;

          # Check env variables
          echo $IS_FEATURE_BRANCH
          echo $RELEASE_NAME
        env:
          GIT_REF: ${{ github.ref }}
          GIT_SHA: ${{ github.sha }}
          REPOSITORY: ${{ github.repository }}